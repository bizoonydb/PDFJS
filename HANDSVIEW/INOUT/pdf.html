<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Editorpdf db</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  color: #ffd900;
  display: flex;
  font-family: Arial, sans-serif;
  overflow: hidden;
}

#editor {
  width: 250px; /* largura fixa do editor */
  background: #444141;
  padding: 20px;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

h2 {
  text-align: center;
}

input, button {
  padding: 8px;
  border-radius: 5px;
  margin: 5px 0;
  border: 1px solid #ff0000;
}

#titulo, #subtitulo {
  display: inline-block;
  padding: 10px;
  font-weight: bold;
  text-align: center;
  border-radius: 8px;
  outline: none;
}

#titulo {
  background: yellow;
  color: black;
}

#subtitulo {
  background: black;
  color: yellow;
  border: 2px solid yellow;
  margin-left: 0px; /* colado no t√≠tulo */
}

#malhas {
  margin-top: 10px;
  text-align: center;
}

.malha {
  display: inline-block;
  padding: 6px 14px;
  margin: 4px;
  color: white;
  border-radius: 6px;
  font-weight: bold;
}

#pdfViewer {
  flex: 1; /* ocupa o restante da tela */
  border: none;
}

.malha {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 14px;
  margin: 4px;
  color: white;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  position: relative;
}

.malha.editing {
  background: #333 !important;
}

.malha input[type="text"] {
  width: 60px;
  margin-right: 5px;
  border-radius: 4px;
  border: none;
  padding: 2px 4px;
}

.malha input[type="color"] {
  width: 24px;
  height: 24px;
  padding: 0;
  
  border: none;
  cursor: pointer;
}
#download {
  background-color: #28a745;
  color: white;
  border: none;
  cursor: pointer;
}
#addMalha {
  background-color: #2898a7;
  color: white;
  border: none;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="editor">
  <h2>üß© DIGITAL BOARD</h2>
  <input type="file" id="file" accept="application/pdf"><br>

  <div contenteditable="true" id="titulo">DIGITAL BOARD   </div>
  <div contenteditable="true" id="subtitulo">SCHEMATC</div>

  <div id="malhas"></div>
  <input type="text" id="nomeMalha" placeholder="Nome da malha">
  <input type="color" id="corMalha" value="#007bff">
  <button id="addMalha">ADD MALHA</button>
  <button id="download">DONWLOAD</button>
</div>
<div id="malhas"></div>

<iframe id="pdfViewer" src="https://mozilla.github.io/pdf.js/web/viewer.html?file="></iframe>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
const { PDFDocument, rgb, StandardFonts } = PDFLib;
let originalPdfBytes = null;
let malhas = [];

const iframe = document.getElementById('pdfViewer');

document.getElementById('file').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  originalPdfBytes = await file.arrayBuffer();

  // carrega PDF no iframe
  const url = URL.createObjectURL(file);
  iframe.src = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}`;
});

document.getElementById('addMalha').addEventListener('click', () => {
  const nome = document.getElementById('nomeMalha').value.trim();
  const cor = document.getElementById('corMalha').value;
  if (!nome) return;
  malhas.push({ nome, cor });
  atualizarMalhas();
  document.getElementById('nomeMalha').value = '';
});

function atualizarMalhas() {
  const div = document.getElementById('malhas');
  div.innerHTML = '';
  malhas.forEach(m => {
    const el = document.createElement('div');
    el.className = 'malha';
    el.style.background = m.cor;
    el.textContent = m.nome;
    div.appendChild(el);
  });
}

document.getElementById('download').addEventListener('click', async () => {
  if (!originalPdfBytes) { alert("Carregue um PDF"); return; }

  const titulo = document.getElementById('titulo').innerText;
  const subtitulo = document.getElementById('subtitulo').innerText;

  const pdfDoc = await PDFDocument.load(originalPdfBytes);
  const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
  const pages = pdfDoc.getPages();

  pages.forEach((page) => {
    const pageWidth = page.getWidth();
    const pageHeight = page.getHeight();

    // --- T√çTULO E SUBT√çTULO ---
    const titleSize = 40;
    const subTitleSize = 30;
    const paddingX = 10;
    const paddingY = 6;
    const radius = 8;

    const titleWidth = font.widthOfTextAtSize(titulo, titleSize);
    const subTitleWidth = font.widthOfTextAtSize(subtitulo, subTitleSize);

    let startX = (pageWidth - (titleWidth + subTitleWidth)) / 2;
    const topY = pageHeight - 40 - titleSize - paddingY;

    // T√çTULO
    page.drawRectangle({
      x: startX - paddingX,
      y: topY,
      width: titleWidth + 2*paddingX,
      height: titleSize + 2*paddingY,
      color: rgb(1,1,0),
      borderColor: rgb(0,0,0),
      borderWidth: 1,
      borderRadius: radius,
    });
    page.drawText(titulo, {
      x: startX,
      y: topY + paddingY,
      size: titleSize,
      font,
      color: rgb(0,0,0)
    });

    // SUBT√çTULO
    const subYOffset = (titleSize + 2*paddingY - (subTitleSize + 2*paddingY)) / 2;
    startX += titleWidth;
    page.drawRectangle({
      x: startX - paddingX,
      y: topY + subYOffset,
      width: subTitleWidth + 2*paddingX,
      height: subTitleSize + 2*paddingY,
      color: rgb(0,0,0),
      borderColor: rgb(1,1,0),
      borderWidth: 1,
      borderRadius: radius
    });
    page.drawText(subtitulo, {
      x: startX,
      y: topY + subYOffset + paddingY,
      size: subTitleSize,
      font,
      color: rgb(1,1,0)
    });

    

    // --- MARCA D'√ÅGUA ---
    const watermarkText = "DIGITAL BOARD";
    const wmFontSize = 15;
    const wmOpacity = 0.2;
    const wmSpacingX = 300;
    const wmSpacingY = 130;
    const wmAngle = -40;

    for (let x = 0; x < pageWidth; x += wmSpacingX) {
      for (let y = 0; y < pageHeight; y += wmSpacingY) {
        page.drawText(watermarkText, {
          x,
          y,
          size: wmFontSize,
          font,
          color: rgb(0,0,0),
          rotate: { type: 'degrees', angle: wmAngle },
          opacity: wmOpacity
        });
      }
    }
    // --- RODAP√â WHATSAPP ---
const footerText = "WHATSAPP/TELEGRAM +55 (33) 98444-4376 ";
const footerFontSize = 12;
const footerY = 10; // 10px do bottom
const footerWidth = font.widthOfTextAtSize(footerText, footerFontSize);
const footerX = (page.getWidth() - footerWidth) / 2;

page.drawText(footerText, {
  x: footerX,
  y: footerY,
  size: footerFontSize,
  font,
  color: rgb(0,0,0)
});


    // --- MALHAS ---
    if(malhas.length > 0){
      const malhaFontSize = 20;
      const malhaHeight = 30;
      const spacing = 15;
      const radiusMalha = 50;

      let totalWidth = 0;
      const malhaWidths = malhas.map(m => {
        const w = font.widthOfTextAtSize(m.nome, malhaFontSize) + 30;
        totalWidth += w;
        return w;
      });
      totalWidth += spacing*(malhas.length-1);

      let startX = (pageWidth - totalWidth)/2;
      const y = 50;

      malhas.forEach((m,i)=>{
        const w = malhaWidths[i];
        const cor = hexToRgb(m.cor);

        page.drawRectangle({
          x: startX,
          y: y,
          width: w,
          height: malhaHeight,
          color: rgb(cor.r/255, cor.g/255, cor.b/255),
          borderRadius: radiusMalha,
        });

        const textW = font.widthOfTextAtSize(m.nome, malhaFontSize);
        const textHeight = malhaFontSize;
        const textX = startX + (w - textW)/2;
        const textY = y + (malhaHeight - textHeight)/2;

        page.drawText(m.nome, {
          x: textX,
          y: textY,
          size: malhaFontSize,
          font,
          color: rgb(1,1,1)
        });
        

        startX += w + spacing;
      });
      
    }
  });

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pdf_editado.pdf";
  link.click();
});

function hexToRgb(hex){
  const bigint = parseInt(hex.slice(1),16);
  return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255 };
}
function atualizarMalhas() {
  const div = document.getElementById('malhas');
  div.innerHTML = '';
  malhas.forEach((m, index) => {
    const el = document.createElement('div');
    el.className = 'malha';
    el.style.background = m.cor;
    el.textContent = m.nome;

    el.addEventListener('click', () => {
      if (el.classList.contains('editing')) return; // j√° em edi√ß√£o
      el.classList.add('editing');
      el.innerHTML = '';

      // input para nome
      const inputNome = document.createElement('input');
      inputNome.type = 'text';
      inputNome.value = m.nome;
      el.appendChild(inputNome);

      // input para cor
      const inputCor = document.createElement('input');
      inputCor.type = 'color';
      inputCor.value = m.cor;
      el.appendChild(inputCor);

      // bot√£o salvar
      const btnSalvar = document.createElement('button');
      btnSalvar.textContent = 'OK';
      btnSalvar.style.marginLeft = '5px';
      btnSalvar.addEventListener('click', () => {
        m.nome = inputNome.value.trim() || m.nome;
        m.cor = inputCor.value;
        atualizarMalhas();
      });
      el.appendChild(btnSalvar);
    });

    div.appendChild(el);
  });
}



</script>

</body>
</html>





