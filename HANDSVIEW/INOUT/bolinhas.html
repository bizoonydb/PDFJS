<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Blocos de Bolinhas com Redimensionar e Ajuste de Tamanho</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    font-family: sans-serif;
    background: #eee;
  }
 #controls {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 70px;
  background: #222;
  color: #eee;
  padding: 10px 20px;
  box-sizing: border-box;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.7);
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 15px;
  overflow-x: auto;
}

/* Itens alinhados horizontalmente */
#controls label {
  margin: 0;
  font-weight: 600;
  color: #ddd;
  font-size: 14px;
  white-space: nowrap;
  user-select: none;
  flex-shrink: 0;
}

#controls input[type="number"],
#controls input[type="file"] {
  background: #333;
  border: 1px solid #555;
  border-radius: 4px;
  color: #eee;
  font-size: 14px;
  padding: 6px 8px;
  margin: 0;
  min-width: 60px;
  max-width: 80px;
  flex-shrink: 0;
}

#controls input[type="number"]:focus,
#controls input[type="file"]:focus {
  border-color: #1e90ff;
  outline: none;
  background: #222;
}

#controls input[type="number"]:disabled {
  background: #444;
  color: #888;
  border-color: #666;
}

#controls button {
  background: #1e90ff;
  border: none;
  color: white;
  font-weight: 700;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  padding: 8px 14px;
  user-select: none;
  flex-shrink: 0;
  white-space: nowrap;
  transition: background-color 0.3s ease;
}

#controls button:hover {
  background: #0d5ecf;
}

/* Remover hr */
#controls hr {
  display: none;
}

hr {
  border: none;
  border-top: 1px solid #444;
  margin: 14px 0;
}

  canvas {
    display: block;
    background: #fff;
    cursor: grab;
  }
  canvas.dragging {
    cursor: grabbing;
  }
</style>
</head>
<body>

<div id="controls">
  <label>Carregar imagem:</label>
  <input type="file" id="imgLoader" accept="image/*" />
  
  <label>Quantidade bolinhas X:</label>
  <input type="number" id="bolinhasX" value="5" min="1" />
  
  <label>Quantidade bolinhas Y:</label>
  <input type="number" id="bolinhasY" value="5" min="1" />
  
  <label>Tamanho bolinhas (px):</label>
  <input type="number" id="tamBolinhas" value="10" min="1" />
  
  <button id="addBlocoBtn">Adicionar bloco de bolinhas</button>
  <hr />
  <label>Tamanho bolinhas do bloco selecionado (px):</label>
  <input type="number" id="tamBolinhasSelecionado" min="1" disabled />
  <button id="saveImgBtn">Salvar imagem</button>
</div>

<canvas id="canvas"></canvas>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const imgLoader = document.getElementById('imgLoader');
  const bolinhasXInput = document.getElementById('bolinhasX');
  const bolinhasYInput = document.getElementById('bolinhasY');
  const tamBolinhasInput = document.getElementById('tamBolinhas');
  const addBlocoBtn = document.getElementById('addBlocoBtn');
  const saveImgBtn = document.getElementById('saveImgBtn');
  const tamBolinhasSelecionadoInput = document.getElementById('tamBolinhasSelecionado');

  let img = new Image();
  let imgLoaded = false;

  // Zoom e pan
  let scale = 1;
  let offsetX = 0;
  let offsetY = 0;

  // Drag (pan) da imagem
  let isDragging = false;
  let dragStart = {x: 0, y: 0};
  let dragOffsetStart = {x: 0, y: 0};

  // Blocos
  let blocos = [];

  // Controle de bloco selecionado
  let selectedBlock = null;

  // Bolinha selecionada no bloco
  let bolinhaSelecionada = null;

  // Redimensionar / arrastar blocos
  let dragTarget = null;
  let resizing = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  // Ajusta canvas ao carregar imagem
  function ajustarCanvasTamanho() {
    if(imgLoaded){
      canvas.width = img.width;
      canvas.height = img.height;
      scale = 1;
      offsetX = 0;
      offsetY = 0;
      desenhar();
    }
  }

  imgLoader.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(evt){
      img.onload = function(){
        imgLoaded = true;
        ajustarCanvasTamanho();
      };
      img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
  });

  function desenhar() {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if(!imgLoaded){
      ctx.fillStyle = '#aaa';
      ctx.font = '20px sans-serif';
      ctx.fillText('Carregue uma imagem', 20, 40);
      return;
    }

    ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
    ctx.drawImage(img, 0, 0);

    blocos.forEach(bloco => {
      const { x, y, width, height, cols, rows, radius } = bloco;

      const espacX = cols > 1 ? width / (cols - 1) : 0;
      const espacY = rows > 1 ? height / (rows - 1) : 0;

      ctx.fillStyle = 'white';
      ctx.strokeStyle = 'transparent';

      for(let col = 0; col < cols; col++){
        for(let row = 0; row < rows; row++){
          const bolinhaIdx = col * rows + row;
          if(bloco.removedBolinhas && bloco.removedBolinhas.has(bolinhaIdx)){
            continue; // pula bolinha removida
          }

          const cx = x + col * espacX;
          const cy = y + row * espacY;
          ctx.beginPath();
          ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
          ctx.fill();

          // Contorno vermelho se bolinha selecionada no bloco selecionado
          if(selectedBlock === bloco && bolinhaSelecionada === bolinhaIdx){
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(cx, cy, radius + 3, 0, 2 * Math.PI);
            ctx.stroke();
          }
        }
      }

      // Se bloco selecionado, desenha contorno do bloco
      if(selectedBlock === bloco){
        ctx.strokeStyle = '#0077cc';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, width, height);

        // Quadradinho para redimensionar
        const resizeMargin = 15;
        ctx.fillStyle = '#0077cc';
        ctx.fillRect(x + width - resizeMargin, y + height - resizeMargin, resizeMargin, resizeMargin);
      }
    });
  }

  function isInsideBlock(x, y, bloco){
    return x >= bloco.x && x <= bloco.x + bloco.width &&
           y >= bloco.y && y <= bloco.y + bloco.height;
  }

  function isOnResizeArea(x, y, bloco){
    const resizeMargin = 15;
    return x >= bloco.x + bloco.width - resizeMargin &&
           x <= bloco.x + bloco.width &&
           y >= bloco.y + bloco.height - resizeMargin &&
           y <= bloco.y + bloco.height;
  }

  // Seleciona bloco pelo clique
  function selecionarBloco(x, y){
    for(let i = blocos.length -1; i >= 0; i--){
      const bloco = blocos[i];
      if(isInsideBlock(x, y, bloco)){
        selectedBlock = bloco;
        tamBolinhasSelecionadoInput.disabled = false;
        tamBolinhasSelecionadoInput.value = bloco.radius;
        desenhar();
        return true;
      }
    }
    // Se não selecionou nenhum
    selectedBlock = null;
    tamBolinhasSelecionadoInput.disabled = true;
    desenhar();
    return false;
  }

  // Detecta bolinha clicada dentro do bloco selecionado
  function detectarBolinhaClicada(mx, my) {
    if (!selectedBlock) return null;

    const { x, y, width, height, cols, rows, radius } = selectedBlock;
    const espacX = cols > 1 ? width / (cols - 1) : 0;
    const espacY = rows > 1 ? height / (rows - 1) : 0;

    for (let col = 0; col < cols; col++) {
      for (let row = 0; row < rows; row++) {
        const bolinhaIdx = col * rows + row;
        if(selectedBlock.removedBolinhas && selectedBlock.removedBolinhas.has(bolinhaIdx)){
          continue;
        }
        const cx = x + col * espacX;
        const cy = y + row * espacY;
        const dx = mx - cx;
        const dy = my - cy;
        if (dx * dx + dy * dy <= radius * radius) {
          return bolinhaIdx;
        }
      }
    }
    return null;
  }

  canvas.addEventListener('mousedown', e => {
    if(!imgLoaded) return;

    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left - offsetX) / scale;
    const my = (e.clientY - rect.top - offsetY) / scale;

    // Primeiro tenta selecionar bloco
    if(selecionarBloco(mx, my)){
      // Verifica se clicou em redimensionar
      if(isOnResizeArea(mx, my, selectedBlock)){
        dragTarget = selectedBlock;
        resizing = true;
        return;
      } else {
        // Arrastar bloco
        dragTarget = selectedBlock;
        resizing = false;
        dragOffsetX = mx - dragTarget.x;
        dragOffsetY = my - dragTarget.y;
        return;
      }
    }

    // Se não clicou em bloco, arrasta imagem (pan)
    dragTarget = null;
    resizing = false;
    isDragging = true;
    dragStart.x = e.clientX;
    dragStart.y = e.clientY;
    dragOffsetStart.x = offsetX;
    dragOffsetStart.y = offsetY;
    selectedBlock = null;
    bolinhaSelecionada = null;
    tamBolinhasSelecionadoInput.disabled = true;
    desenhar();
  });

  canvas.addEventListener('mousemove', e => {
    if(!imgLoaded) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left - offsetX) / scale;
    const my = (e.clientY - rect.top - offsetY) / scale;

    if(dragTarget){
      if(resizing){
        dragTarget.width = Math.max(10, mx - dragTarget.x);
        dragTarget.height = Math.max(10, my - dragTarget.y);
      } else {
        dragTarget.x = mx - dragOffsetX;
        dragTarget.y = my - dragOffsetY;

        dragTarget.x = Math.min(Math.max(0, dragTarget.x), img.width - dragTarget.width);
        dragTarget.y = Math.min(Math.max(0, dragTarget.y), img.height - dragTarget.height);
      }
      desenhar();
    } else if(isDragging) {
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      offsetX = dragOffsetStart.x + dx;
      offsetY = dragOffsetStart.y + dy;
      desenhar();
    }
  });

  canvas.addEventListener('mouseup', e => {
    dragTarget = null;
    resizing = false;
    isDragging = false;
    canvas.classList.remove('dragging');
  });

  canvas.addEventListener('mouseleave', e => {
    dragTarget = null;
    resizing = false;
    isDragging = false;
    canvas.classList.remove('dragging');
  });

  canvas.addEventListener('click', e => {
    if(!imgLoaded) return;

    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left - offsetX) / scale;
    const my = (e.clientY - rect.top - offsetY) / scale;

    // Seleciona bloco ao clicar fora do drag
    if(!dragTarget){
      selecionarBloco(mx, my);

      if(selectedBlock){
        const idx = detectarBolinhaClicada(mx, my);
        if(idx !== null){
          bolinhaSelecionada = idx;
          desenhar();
          return;
        } else {
          bolinhaSelecionada = null;
          desenhar();
        }
      } else {
        bolinhaSelecionada = null;
        desenhar();
      }
    }
  });

  // Zoom roda mouse
  canvas.addEventListener('wheel', e => {
    if(!imgLoaded) return;
    e.preventDefault();

    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const x = (mx - offsetX) / scale;
    const y = (my - offsetY) / scale;

    const zoomAmount = e.deltaY < 0 ? 1.1 : 0.9;
    scale *= zoomAmount;

    scale = Math.min(Math.max(scale, 0.1), 10);

    offsetX = mx - x * scale;
    offsetY = my - y * scale;

    desenhar();
  }, { passive: false });

  // Adicionar bloco
  // Cria um bloco no ponto (mx, my) em coordenadas do mundo real
function criarBlocoEm(mx, my) {
  const cols = Math.max(1, parseInt(bolinhasXInput.value));
  const rows = Math.max(1, parseInt(bolinhasYInput.value));
  const radius = Math.max(1, parseInt(tamBolinhasInput.value));
  const largura = 200;
  const altura = 200;

  const novoBloco = {
    x: mx - largura / 2,
    y: my - altura / 2,
    width: largura,
    height: altura,
    cols,
    rows,
    radius,
    removedBolinhas: new Set()
  };

  blocos.push(novoBloco);
  selectedBlock = novoBloco;
  bolinhaSelecionada = null;
  tamBolinhasSelecionadoInput.disabled = false;
  tamBolinhasSelecionadoInput.value = radius;
  desenhar();
}

// Clique direito no canvas cria novo bloco
canvas.addEventListener('contextmenu', e => {
  e.preventDefault();
  if (!imgLoaded) return;

  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left - offsetX) / scale;
  const my = (e.clientY - rect.top - offsetY) / scale;

  criarBlocoEm(mx, my);
});

// Botão manual também cria novo bloco no centro da tela visível
addBlocoBtn.addEventListener('click', () => {
  if (!imgLoaded) return;

  const rect = canvas.getBoundingClientRect();
  const centroX = (rect.width / 2 - offsetX) / scale;
  const centroY = (rect.height / 2 - offsetY) / scale;

  criarBlocoEm(centroX, centroY);
});

  // Alterar tamanho bolinhas do bloco selecionado em tempo real
  tamBolinhasSelecionadoInput.addEventListener('input', () => {
    if(selectedBlock){
      let val = Math.max(1, parseInt(tamBolinhasSelecionadoInput.value));
      selectedBlock.radius = val;
      desenhar();
    }
  });

  // Salvar imagem
  saveImgBtn.addEventListener('click', () => {
    if(!imgLoaded){
      alert('Carregue uma imagem primeiro.');
      return;
    }
    const tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = img.width;
    tmpCanvas.height = img.height;
    const tmpCtx = tmpCanvas.getContext('2d');
    tmpCtx.drawImage(img, 0, 0);

    blocos.forEach(bloco => {
      const { x, y, width, height, cols, rows, radius } = bloco;
      const espacX = cols > 1 ? width / (cols - 1) : 0;
      const espacY = rows > 1 ? height / (rows - 1) : 0;

      tmpCtx.fillStyle = 'white';
      for(let col = 0; col < cols; col++){
        for(let row = 0; row < rows; row++){
          const bolinhaIdx = col * rows + row;
          if(bloco.removedBolinhas && bloco.removedBolinhas.has(bolinhaIdx)){
            continue; // pula bolinha removida
          }
          const cx = x + col * espacX;
          const cy = y + row * espacY;
          tmpCtx.beginPath();
          tmpCtx.arc(cx, cy, radius, 0, 2 * Math.PI);
          tmpCtx.fill();
        }
      }
    });

    const dataURL = tmpCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'imagem_com_bolinhas.png';
    a.click();
  });

  // Apagar bolinha selecionada com tecla "X"
  document.addEventListener('keydown', e => {
    if(e.key.toLowerCase() === 'x' && selectedBlock !== null && bolinhaSelecionada !== null){
      if(!selectedBlock.removedBolinhas) selectedBlock.removedBolinhas = new Set();
      selectedBlock.removedBolinhas.add(bolinhaSelecionada);
      bolinhaSelecionada = null;
      desenhar();
    }
  });

desenhar();
</script>

</body> </html>
