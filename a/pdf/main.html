<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PDF.js Express</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .searchPanel {

            width: 150px;
        }

        .sidebar {
            width: 25%;
            background: #f4f4f4;
            padding: 5px;
            overflow-y: auto;
            border-right: 2px solid #ddd;
            flex-shrink: 0;


        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 5px 0;
            cursor: pointer;
            /* transition: background 0.3s; */
        }



        .pdf-viewer {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #tabHeaders {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            border-bottom: 2px solid #ccc;
            padding: 10px;
            max-width: 90%;
            margin-right: 30px;
            /* scrollbar-width: thin; */
        }

        #tabHeaders::-webkit-scrollbar {
            height: 8px;
        }

        #tabHeaders::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .tab {
            padding: 10px 20px;
            margin-right: 10px;
            background: #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .close-btn {
            margin-left: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        /* #pdf-ui {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        } */

        #pdf-ui {
            overflow-y: auto;
            flex-grow: 1;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            padding: 20px;
        }


        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #categoryList {
            margin-top: 20px;
        }

        /* Tree styling */
        .tree {
            list-style-type: none;
            padding-left: 20px;
        }

        .tree li {
            margin: 5px 0;
        }

        #sidebar ul {
            margin: 0;
            padding-left: 20px;
            list-style: none;
            line-height: 1em;
        }

        #sidebar ul li {
            position: relative;
        }

        #sidebar ul li::before,
        #sidebar ul li::after {
            content: "";
            position: absolute;
            left: -15px;
            border-left: 2px dashed #999;
        }

        #sidebar ul li::before {
            top: 0;
            width: 15px;
            height: 1em;
            border-bottom: 2px dashed #999;
        }

        #sidebar ul.tree>li:first-child::before {
            border-left: none;
        }

        #sidebar ul li::after {
            top: 1.1em;
            bottom: 1px;
        }

        #sidebar ul li:last-child::after {
            display: none;
        }

        .bxs-file-pdf {
            color: gray;
            /* PDF icon color */
            margin-right: 5px;
        }




        #pdfContainers {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            overflow: hidden;
        }

        .pdf-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* Hide by default */
        }

        .pdf-container.active {
            display: block;
            /* Show only the active PDF */
        }

        .results {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Import PDF.js Express -->
    <script src="PDFJSExpress/lib/webviewer.min.js"></script>


    <div class="sidebar" id="sidebar">
        <img src="./assets/logo.png" alt="Logo" style="width: 30%;">
        <div id="loadingSpinner" class="loading-spinner"></div>
        <ul class="tree" id="categoryList"></ul>
    </div>

    <div class="pdf-viewer">
        <div id="tabHeaders"></div>
        <div id="pdfContainers"></div>
        <!-- <div id="viewer" style="width: 100%; height: 100%; margin: 0 auto;"></div> -->
    </div>



    <!-- PDF Viewer Container -->

</body>

<script>


    function renderCategories(categories, parentElement) {
        categories.forEach((category) => {
            const li = document.createElement('li');
            li.setAttribute('data-name', category.name.toLowerCase());

            // Create a span for category name or PDF link
            const span = document.createElement('span');
            span.textContent = category.name;

            if (category.pdfs && category.pdfs.length > 0) {
                // Ensure the PDF icon and clickable span are rendered correctly
                span.innerHTML = `
                        <i class="bx bxs-file-pdf"></i> 
                        ${category.name}
                    `;
                span.style.cursor = 'pointer';
                span.onclick = () => openTab(category.pdfs[0].pdf, category.id, category.name);
            }

            // Create a container for children (if any)
            const childContainer = document.createElement('ul');
            childContainer.style.display = 'none'; // Initially hide children

            // If there are children, add an expand/collapse toggle
            if (category.children && category.children.length > 0) {
                const toggleIcon = document.createElement('span');
                toggleIcon.textContent = '▶'; // Collapsed icon
                toggleIcon.style.cursor = 'pointer';
                toggleIcon.style.marginRight = '5px';

                // Expand/Collapse logic
                toggleIcon.addEventListener('click', () => {
                    if (childContainer.style.display === 'none') {
                        childContainer.style.display = 'block';
                        toggleIcon.textContent = '▼'; // Expanded icon
                    } else {
                        childContainer.style.display = 'none';
                        toggleIcon.textContent = '▶'; // Collapsed icon
                    }
                });

                li.appendChild(toggleIcon);
            }

            li.appendChild(span);

            // Recursively render children
            if (category.children && category.children.length > 0) {
                renderCategories(category.children, childContainer);
                li.appendChild(childContainer);
            }

            parentElement.appendChild(li);
        });
    }


    function openTab(pdfUrl, tabId, catname) {
        const tabHeaders = document.getElementById('tabHeaders');

        // If tab already exists, just switch to it
        if (document.querySelector(`.tab[data-tab-id="${tabId}"]`)) {
            switchTab(tabId);
            return;
        }

        // Create new tab
        const newTab = document.createElement('div');
        newTab.className = 'tab';
        newTab.setAttribute('data-tab-id', tabId);
        newTab.innerHTML = `${catname} <span class="close-btn" onclick="closeTab('${tabId}')">✕</span>`;
        newTab.addEventListener('click', () => switchTab(tabId));
        tabHeaders.appendChild(newTab);

        // Load PDF and switch to the new tab
        loadPDF(`https://skillbypm.com/public/${pdfUrl}`, tabId);
        switchTab(tabId);
    }

    // function openTab(pdfUrl, tabId) {
    //     const tabHeaders = document.getElementById('tabHeaders');

    //     // If tab already exists, just switch to it
    //     if (document.querySelector(`.tab[data-tab-id="${tabId}"]`)) {
    //         switchTab(tabId);
    //         return;
    //     }

    //     // Create new tab
    //     const newTab = document.createElement('div');
    //     newTab.className = 'tab';
    //     newTab.setAttribute('data-tab-id', tabId);
    //     newTab.innerHTML = ` <span class="close-btn" onclick="closeTab('${tabId}')">✕</span>`;
    //     newTab.addEventListener('click', () => switchTab(tabId));
    //     tabHeaders.appendChild(newTab);

    //     // Switch to new tab and load PDF
    //     switchTab(tabId, `https://skillbypm.com/public/${pdfUrl}`);
    // }

    // function openTab(pdfUrl, tabId) {
    //     const tabHeaders = document.getElementById('tabHeaders');
    //     const pdfUI = document.getElementById('viewer');

    //     const existingTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
    //     if (existingTab) {
    //         switchTab(tabId);
    //         return;
    //     }

    //     const newTab = document.createElement('div');
    //     newTab.className = 'tab';
    //     newTab.setAttribute('data-tab-id', tabId);
    //     newTab.innerHTML = `PDF ${tabId} <span class="close-btn" onclick="closeTab(event, '${tabId}')">✕</span>`;
    //     newTab.addEventListener('click', () => switchTab(tabId));
    //     tabHeaders.appendChild(newTab);

    //     const tabContent = document.createElement('div');
    //     tabContent.className = 'pdf-container';
    //     tabContent.setAttribute('data-tab-id', tabId);
    //     tabContent.style.display = 'none';

    //     pdfUI.appendChild(tabContent);

    //     switchTab(tabId);
    //     loadPDF(`https://skillbypm.com/public/${pdfUrl}`, tabContent);

    //     tabHeaders.scrollLeft = tabHeaders.scrollWidth;
    // }

    function switchTab(tabId) {
        // Hide all PDF containers and deactivate tabs
        document.querySelectorAll('.pdf-container').forEach(container => container.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

        // Show the selected PDF container and mark tab as active
        const activeContainer = document.getElementById(`pdfContainer-${tabId}`);
        if (activeContainer) activeContainer.classList.add('active');

        const activeTab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
        if (activeTab) activeTab.classList.add('active');

        // Update the current active tab
        activeTabId = tabId;
    }
    function closeTab(tabId) {
        // Remove tab from DOM
        const tab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
        if (tab) tab.remove();

        // Dispose WebViewer instance and remove PDF container
        if (instances[tabId]) {
            instances[tabId].dispose();
            delete instances[tabId];
        }

        const pdfContainer = document.getElementById(`pdfContainer-${tabId}`);
        if (pdfContainer) pdfContainer.remove();

        // Switch to the last available tab if active tab is closed
        if (activeTabId === tabId) {
            const remainingTabs = document.querySelectorAll('.tab');
            if (remainingTabs.length > 0) {
                switchTab(remainingTabs[remainingTabs.length - 1].getAttribute('data-tab-id'));
            }
        }
    }







    // Open PDF in a new tab (or Electron window if required)
    // function openTab(pdfUrl, identifier) {
    //     // Ensure the pdfUrl is properly inserted into the URL string
    //     loadPDF(`https://skillbypm.com/public/${pdfUrl}`);

    //     console.log(`Opening PDF: ${pdfUrl} with ID: ${identifier}`);

    // }

    const instances = {}; // Store WebViewer instances
    let activeTabId = null; // Keep track of the active tab

    // Load PDF in a new viewer inside a unique container
    function loadPDF(pdfUrl, tabId) {
        // Create a unique PDF container for this tab
        const pdfContainers = document.getElementById('pdfContainers');
        const newContainer = document.createElement('div');
        newContainer.id = `pdfContainer-${tabId}`;
        newContainer.className = 'pdf-container';
        pdfContainers.appendChild(newContainer);

        // Initialize WebViewer in the new container
        WebViewer({
            // path: 'https://skillbypm.com/api/PDFJSExpress/lib',
            path: 'PDFJSExpress/lib',
            licenseKey: 'QJy8A4JLxYqkFHkTrypQ',
            initialDoc: pdfUrl,
        }, newContainer).then(instance => {








            // const { documentViewer } = instance.Core;

            // documentViewer.getTool('TextSelect').addEventListener('selectionComplete', (startLocation, allQuads) => {
            //     const selectedText = documentViewer.getSelectedText();
            //     console.log(selectedText);
            // });


            //const { documentViewer } = instance.Core;





            const { documentViewer } = instance.Core;

            // const { Tools } = instance.Core;

            // const panTool = Tools.ToolNames.PAN;

            // instance.UI.setToolMode(panTool);





            // Ensure the document is loaded before interacting with it
            documentViewer.addEventListener('documentLoaded', () => {
                console.log('Document Loaded!');


                const iframeInterval = setInterval(() => {
                    const iframe = newContainer.querySelector('iframe');

                    if (iframe && iframe.contentDocument) {
                        clearInterval(iframeInterval);
                        console.log('Iframe loaded successfully.');



                        iframe.contentWindow.addEventListener('wheel', (e) => {
                            e.preventDefault(); // Prevent default scrolling behavior

                            // Get the zoom-in and zoom-out buttons
                            const zoomInButton = iframe.contentDocument.querySelector('[data-element="zoomInButton"]');
                            const zoomOutButton = iframe.contentDocument.querySelector('[data-element="zoomOutButton"]');

                            if (zoomInButton && zoomOutButton) {
                                // Zoom in on scroll up (wheel scroll up)
                                if (e.deltaY < 0) {
                                    zoomInButton.click();
                                    console.log('Zoom In Button clicked.');
                                }
                                // Zoom out on scroll down (wheel scroll down)
                                else if (e.deltaY > 0) {
                                    zoomOutButton.click();
                                    console.log('Zoom Out Button clicked.');
                                }
                            } else {
                                if (!zoomInButton) {
                                    console.warn('Element with data-element="zoomInButton" not found.');
                                }
                                if (!zoomOutButton) {
                                    console.warn('Element with data-element="zoomOutButton" not found.');
                                }
                            }
                        }, { passive: false }); // Set the listener to be non-passive

























                        // Get the TextSelect tool
                        const textSelectTool = documentViewer.getTool('TextSelect');

                        // Listen for text selection completion
                        textSelectTool.addEventListener('selectionComplete', () => {
                            const selectedText = documentViewer.getSelectedText();
                            console.log('Selected Text:', selectedText);

                            // Access searchPanel within the iframe
                            const searchPanel = iframe.contentDocument.querySelector('[data-element="searchButton"]');
                            if (searchPanel) {
                                searchPanel.classList.add('active');
                                console.log('Added "open" class to search panel.');
                            } else {
                                console.warn('Element with data-element="searchPanel" not found.');
                            }


                            // Trigger search if text is selected
                            if (selectedText) {

                                //instance.UI.enableElements(['searchPanel']);
                                instance.UI.searchTextFull(selectedText, {
                                    // caseSensitive: true,
                                    // wholeWord: true
                                });
                                instance.UI.toggleElement('searchPanel')
                                console.log(`Searching for: ${selectedText}`);
                            }

                            // Click the search button if found
                            const searchButton = iframe.contentDocument.querySelector('[data-element="searchButton"]');
                            if (searchButton) {
                                searchButton.click();
                                console.log('Clicked search button.');
                            } else {
                                console.warn('Search button not found inside iframe.');
                            }
                        });
                    }
                }, 100);


                // // Delay to ensure the DOM is fully updated
                // setTimeout(() => {
                //     const textSelectTool = documentViewer.getTool('TextSelect');

                //     // Listen for text selection completion
                //     textSelectTool.addEventListener('selectionComplete', () => {
                //         const selectedText = documentViewer.getSelectedText();
                //         console.log('Selected Text:', selectedText);



                //         // // Open search panel
                //         // const searchPanel = document.querySelector('[data-element="searchPanel"]');
                //         // if (searchPanel) {
                //         //     searchPanel.classList.add('open');
                //         //     console.log('Added "open" class to search panel.');
                //         // } else {
                //         //     console.warn('Element with data-element="searchPanel" not found.');
                //         // }

                //         // // Set selected text in the input box
                //         // const searchInput = document.getElementById('SearchPanel__input');
                //         // if (searchInput) {
                //         //     searchInput.value = selectedText;
                //         //     console.log('Text added to search input.');
                //         // } else {
                //         //     console.warn('Input box with id="SearchPanel__input" not found.');
                //         // }

                //         // Click the search button
                //         // const searchButton = document.querySelector('[data-element="searchButton"]');
                //         // if (searchButton) {
                //         //     searchButton.click();
                //         //     console.log('Search button clicked.');
                //         // } else {
                //         //     console.warn('Button with data-element="searchButton" not found.');
                //         // }


                //     });
                // }, 500); // Adjust delay if necessary
            });






            instance.UI.setTheme('light');
            instance.UI.disableElements(['ribbons']);

            // instance.UI.disableElements(['leftPanel', 'leftPanelButton', 'menuButton',
            //     'toggleNotesButton', 'viewControlsButton', 'selectToolButton', 'textPopup']);


            instance.UI.disableElements(['leftPanel', 'leftPanelButton', 'menuButton',
                'toggleNotesButton', 'viewControlsButton', 'textPopup', 'toolsHeader']);

            instance.UI.disableElements(['fullscreenButton'])


            // instance.UI.setHeaderItems((header) => {
            //     header.getHeader('default').push({
            //         img: "icon-header-full-screen",
            //         index: -1,
            //         type: "actionButton",
            //         element: 'searchPanel',
            //         onClick: () => {
            //             instance.UI.toggleFullScreen()
            //         }
            //     });
            // });

            // instance.UI.enableElements(['selectToolButton']);


            instances[tabId] = instance; // Store instance by tabId
            console.log(`PDF Loaded for Tab: ${tabId}`);
        }).catch(error => console.error('Error loading PDF:', error));
    }


    // function loadPDF(pdfUrl) {
    //     WebViewer({
    //         path: 'PDFJSExpress/lib', // Path to the PDF.js Express 'lib' folder
    //         licenseKey: 'QJy8A4JLxYqkFHkTrypQ',
    //         initialDoc: pdfUrl, // Load PDF from the provided URL
    //     }, document.getElementById('viewer'))
    //         .then(instance => {
    //             const docViewer = instance.docViewer;
    //             const annotManager = instance.annotManager;

    //             // Access major namespaces if needed
    //             // const Tools = instance.Tools;
    //             // const Annotations = instance.Annotations;

    //             docViewer.on('documentLoaded', () => {
    //                 console.log('PDF Loaded:', pdfUrl);
    //                 // Additional actions when the PDF is loaded
    //             });
    //         })
    //         .catch(error => {
    //             console.error('Error loading PDF:', error);
    //         });
    // }






    // Fetch and display categories in the sidebar
    async function loadCategories() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.style.display = 'block';  // Show the loading spinner inside sidebar

        try {
            const response = await fetch('https://skillbypm.com/api/categories.php');
            const data = await response.json();

            if (data.status === 'success' && data.categories.length > 0) {
                const treeContainer = document.getElementById('categoryList');
                renderCategories(data.categories, treeContainer);
            } else {
                console.error('No categories available or error fetching categories:', data.message);
                const treeContainer = document.getElementById('categoryList');
                treeContainer.innerHTML = '<li>No categories available</li>';
            }
        } catch (error) {
            console.error('Network error:', error);
            const treeContainer = document.getElementById('categoryList');
            treeContainer.innerHTML = '<li>Error loading categories. Please try again later.</li>';
        } finally {
            loadingSpinner.style.display = 'none';  // Hide the loading spinner after data is loaded
        }
    }

    // Load categories on page load
    document.addEventListener('DOMContentLoaded', loadCategories);




    // document.addEventListener('wheel', function (event) {
    //     event.preventDefault(); // Prevents page scrolling

    //     console.log('Mouse wheel event detected:', event.deltaY);

    //     const zoomOutButton = document.querySelector('[data-element="zoomOutButton"]');
    //     const zoomInButton = document.querySelector('[data-element="zoomInButton"]');

    //     // Debug: Check if buttons are found
    //     console.log('Zoom Out Button:', zoomOutButton);
    //     console.log('Zoom In Button:', zoomInButton);

    //     if (event.deltaY > 0) {
    //         console.log('Zooming Out...');
    //         zoomOutButton?.click();
    //     } else if (event.deltaY < 0) {
    //         console.log('Zooming In...');
    //         zoomInButton?.click();
    //     }
    // });





</script>

</html>